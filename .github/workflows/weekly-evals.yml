name: Weekly RAG Evaluations

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual trigger from GitHub UI
    inputs:
      run_basic:
        description: 'Run Basic RAG Evaluation'
        required: false
        default: true
        type: boolean
      run_multiturn:
        description: 'Run Multi-turn Evaluation'
        required: false
        default: true
        type: boolean
      reason:
        description: 'Reason for running evaluation'
        required: false
        default: 'Manual trigger'
        type: string
  pull_request:  # Also run on PRs for continuous testing
    paths:
      - 'src/**'
      - 'evals/**'
      - '.github/workflows/weekly-evals.yml'

jobs:
  eval-basic:
    name: Run Basic RAG Evaluation
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || inputs.run_basic
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run Basic Evaluation with Braintrust
      uses: braintrustdata/eval-action@v1
      with:
        api-key: ${{ secrets.BRAINTRUST_API_KEY }}
        runtime: python
        command: python evals/eval_basic.py
        project: rag-braintrust-bot
        comment-on-pr: true  # Add evaluation results as PR comment
      env:
        BRAINTRUST_API_KEY: ${{ secrets.BRAINTRUST_API_KEY }}
        BRAINTRUST_PROJECT_NAME: ${{ vars.BRAINTRUST_PROJECT_NAME }}
        PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
        VOYAGEAI_API_KEY: ${{ secrets.VOYAGEAI_API_KEY }}
        INDEX_NAME: ${{ vars.INDEX_NAME }}

  eval-multiturn:
    name: Run Multi-turn Conversation Evaluation
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || inputs.run_multiturn
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run Multi-turn Evaluation with Braintrust
      uses: braintrustdata/eval-action@v1
      with:
        api-key: ${{ secrets.BRAINTRUST_API_KEY }}
        runtime: python
        command: python evals/eval_multiturn.py
        project: rag-braintrust-bot
        comment-on-pr: true  # Add evaluation results as PR comment
      env:
        BRAINTRUST_API_KEY: ${{ secrets.BRAINTRUST_API_KEY }}
        BRAINTRUST_PROJECT_NAME: ${{ vars.BRAINTRUST_PROJECT_NAME }}
        PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
        VOYAGEAI_API_KEY: ${{ secrets.VOYAGEAI_API_KEY }}
        INDEX_NAME: ${{ vars.INDEX_NAME }}

  summary:
    name: Evaluation Summary
    needs: [eval-basic, eval-multiturn]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Create summary
      run: |
        echo "## ðŸ“Š Weekly RAG Evaluation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Evaluations Completed:" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Basic RAG Evaluation" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Multi-turn Conversation Evaluation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### View Results:" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— [Braintrust Dashboard](https://www.braintrust.dev/app/carlos/p/rag-braintrust-bot)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The Braintrust Action automatically tracks experiments and provides detailed metrics." >> $GITHUB_STEP_SUMMARY